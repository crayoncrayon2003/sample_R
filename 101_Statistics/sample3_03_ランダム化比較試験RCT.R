main <- function() {
  # ###############################################################################################
  # RCTは、個体に対して処置変数をランダムに割り当て、その結果として生じる結果変数Yを観測する実験設計である。
  #
  # 例えば、E[Y | X1, X2] に関して、
  # ・説明変数 X1（風邪薬）は、研究者が外部から操作して個体にランダムに割り当てる処置変数である
  # ・説明変数 X2（重症度）は、個体が元々もつ属性を仮定した共変量である
  #
  # このとき、RCTでは研究者が処置変数として定義した変数のみを用いて個体に対してランダム化を行う。
  # ランダム化の対象となるのは処置変数として選んだものに限られる。
  #
  # このため、
  # ・説明変数 X1（風邪薬）は RCT の対象である
  # ・説明変数 X2（重症度）は RCT の対象外である
  # ###############################################################################################

  ## ===============================
  ## 基本設定
  ## ===============================

  set.seed(123)
  n <- 100  # 被験者数

  ## ===============================
  ## データ生成
  ## ===============================
  #
  # X2 : 個体の属性（重症度）
  #   → 観測研究では交絡変数になりうるが、
  #      RCTでは X1 と独立なので交絡にはならない
  #
  # X1 : 処置（風邪薬）
  #   1 = あり, 0 = なし
  #   → ランダム化比較試験（RCT）なので X2 と独立に割付

  #######################################################################
  # RCT は データ生成そのもののランダム化ではない。
  # 処置の割り当てをランダムにする。
  # 処置変数X1 を、個体の属性や潜在反応変数と独立にランダム割付する実験設計
  #######################################################################

  df <- data.frame(
    x2 = rbinom(n, 1, 0.5),  # 重症度
    x1 = rbinom(n, 1, 0.5)   # 風邪薬（ランダム割付）
  )

  ## ===============================
  ## 潜在反応変数の考え方（概念）
  ## ===============================
  #
  # 各個人 i には、以下の潜在反応変数が存在すると考える：
  #
  #   Y_i(1): 風邪薬を飲んだ場合の結果
  #   Y_i(0): 風邪薬を飲まなかった場合の結果
  #
  # ただし、その分布は交絡変数 X2（重症度）に依存する：
  #
  #   P(Y_i(1)=1 | X2=1) = 0.8
  #   P(Y_i(1)=1 | X2=0) = 0.5
  #   P(Y_i(0)=1 | X2=1) = 0.4
  #   P(Y_i(0)=1 | X2=0) = 0.2
  #
  # 実際に観測できるのは、
  # 割り当てられた X1 に対応する潜在反応変数 1 つのみ

  ## ===============================
  ## 結果変数 Y の生成
  ## ===============================
  #
  # 観測された X1 に応じて、
  # 対応する潜在反応変数 Y_i(X1) が実現する

  df$y <- mapply(function(x1, x2) {
    if (x1 == 1 & x2 == 1) rbinom(1, 1, 0.8)
    else if (x1 == 1 & x2 == 0) rbinom(1, 1, 0.5)
    else if (x1 == 0 & x2 == 1) rbinom(1, 1, 0.4)
    else                        rbinom(1, 1, 0.2)
  }, df$x1, df$x2)

  print(df)

  ## ===============================
  ## 条件付き期待値
  ## ===============================

  # E[Y | X1 = 1]
  e_y_x1_1 <- mean(df$y[df$x1 == 1])

  # E[Y | X1 = 0]
  e_y_x1_0 <- mean(df$y[df$x1 == 0])

  # E[Y | X1, X2]
  e_y_x1_1_x2_1 <- mean(df$y[df$x1 == 1 & df$x2 == 1])
  e_y_x1_1_x2_0 <- mean(df$y[df$x1 == 1 & df$x2 == 0])
  e_y_x1_0_x2_1 <- mean(df$y[df$x1 == 0 & df$x2 == 1])
  e_y_x1_0_x2_0 <- mean(df$y[df$x1 == 0 & df$x2 == 0])

  ## ===============================
  ## 条件付き分散（二値変数なので p(1-p)）
  ## ===============================

  # Var(Y | X1 = 1)
  var_y_x1_1 <- e_y_x1_1 * (1 - e_y_x1_1)

  # Var(Y | X1 = 0)
  var_y_x1_0 <- e_y_x1_0 * (1 - e_y_x1_0)

  ## ===============================
  ## 出力
  ## ===============================

  cat("【ランダム化比較試験（RCT）の結果】\n\n")

  cat("E[Y | X1 = 1] =", e_y_x1_1, "\n")
  cat("E[Y | X1 = 0] =", e_y_x1_0, "\n")
  cat("ATE ≈ E[Y | X1=1] - E[Y | X1=0] =",
      e_y_x1_1 - e_y_x1_0, "\n\n")

  cat("Var(Y | X1 = 1) =", var_y_x1_1, "\n")
  cat("Var(Y | X1 = 0) =", var_y_x1_0, "\n\n")

  cat("【X2（重症度）で条件付けた期待値】\n")
  cat("E[Y | X1=1, X2=1] =", e_y_x1_1_x2_1, "\n")
  cat("E[Y | X1=1, X2=0] =", e_y_x1_1_x2_0, "\n")
  cat("E[Y | X1=0, X2=1] =", e_y_x1_0_x2_1, "\n")
  cat("E[Y | X1=0, X2=0] =", e_y_x1_0_x2_0, "\n\n")

  cat("【潜在反応変数の整理】\n")
  cat("各個人には Y(1), Y(0) という潜在反応変数が存在する。\n")
  cat("観測される Y は、そのうち実際に割り当てられた X1 に対応する1つのみである。\n")
  cat("RCTでは X1 がランダム化されているため、E[Y | X1] は因果効果を表す。\n")
}

main()
