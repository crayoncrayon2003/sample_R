main <- function() {
  # ###############################################################################################
  # RCTは、個体に対して処置変数をランダムに割り当て、その結果として生じる結果変数Yを観測する実験設計である。
  #
  # 例えば、E[Y | X1, X2] に関して、
  # ・説明変数 X1（風邪薬）は、研究者が外部から操作して個体にランダムに割り当てる処置変数と定義する
  # ・説明変数 X2（重症度）は、個体が元々もつ属性を仮定した共変量と定義する
  #
  # このとき、RCTでは研究者が処置変数として定義した変数のみを用いて個体に対してランダム化を行う。
  # ランダム化の対象となるのは処置変数として選んだものに限られる。
  #
  # このため、
  # ・説明変数 X1（風邪薬）は RCT の対象である
  # ・説明変数 X2（重症度）は RCT の対象外である
  # ###############################################################################################

  ## ===============================
  ## 基本設定
  ## ===============================

  set.seed(123)
  n <- 3000  # 被験者数

  ## ===============================
  ## データ生成
  ## ===============================
  #
  # X2 : 個体の属性（重症度）
  #   → 観測研究では交絡変数になりうるが、
  #      RCTでは X1 と独立なので交絡にはならない
  #
  # X1 : 処置（風邪薬）
  #   1 = あり, 0 = なし
  #   → ランダム化比較試験（RCT）なので X2 と独立に割付

  #######################################################################
  # RCT は データ生成そのもののランダム化ではない。
  # 処置の割り当てをランダムにする。
  # 処置変数X1 を、個体の属性や潜在反応変数と独立にランダム割付する実験設計
  #######################################################################

  df <- data.frame(
    x2 = rbinom(n, 1, 0.5),  # 重症度
    x1 = rbinom(n, 1, 0.5)   # 風邪薬（ランダム割付）
  )

  ## ===============================
  ## 潜在反応変数の考え方（概念）
  ## ===============================
  #
  # 各個人 i には、以下の潜在反応変数が存在すると考える：
  #
  #   Y_i(1): 風邪薬を飲んだ場合の結果
  #   Y_i(0): 風邪薬を飲まなかった場合の結果
  #
  # ただし、その分布は交絡変数 X2（重症度）に依存する：
  #
  #   P(Y_i(1)=1 | X2=1) = 0.8
  #   P(Y_i(1)=1 | X2=0) = 0.5
  #   P(Y_i(0)=1 | X2=1) = 0.4
  #   P(Y_i(0)=1 | X2=0) = 0.2
  #
  # 実際に観測できるのは、
  # 割り当てられた X1 に対応する潜在反応変数 1 つのみ

  ## ===============================
  ## 結果変数 Y の生成
  ## ===============================
  #
  # 観測された X1 に応じて、
  # 対応する潜在反応変数 Y_i(X1) が実現する

  df$y <- mapply(function(x1, x2) {
    if (x1 == 1 & x2 == 1) rbinom(1, 1, 0.8)
    else if (x1 == 1 & x2 == 0) rbinom(1, 1, 0.5)
    else if (x1 == 0 & x2 == 1) rbinom(1, 1, 0.4)
    else                        rbinom(1, 1, 0.2)
  }, df$x1, df$x2)

  print(df)

  ## ===============================
  ## 条件付き期待値
  ## ===============================

  # E[Y | X1 = 1]
  e_y_x1_1 <- mean(df$y[df$x1 == 1])

  # E[Y | X1 = 0]
  e_y_x1_0 <- mean(df$y[df$x1 == 0])

  # E[Y | X1, X2]
  e_y_x1_1_x2_1 <- mean(df$y[df$x1 == 1 & df$x2 == 1])
  e_y_x1_1_x2_0 <- mean(df$y[df$x1 == 1 & df$x2 == 0])
  e_y_x1_0_x2_1 <- mean(df$y[df$x1 == 0 & df$x2 == 1])
  e_y_x1_0_x2_0 <- mean(df$y[df$x1 == 0 & df$x2 == 0])

  ## ===============================
  ## 条件付き分散（二値変数なので p(1-p)）
  ## ===============================

  # Var(Y | X1 = 1)
  var_y_x1_1 <- e_y_x1_1 * (1 - e_y_x1_1)

  # Var(Y | X1 = 0)
  var_y_x1_0 <- e_y_x1_0 * (1 - e_y_x1_0)

  ## ===============================
  ## 出力
  ## ===============================

  cat("【ランダム化比較試験（RCT）の結果】\n\n")

  cat("E[Y | X1 = 1] =", e_y_x1_1, "\n")
  cat("E[Y | X1 = 0] =", e_y_x1_0, "\n")
  cat("ATE ≈ E[Y | X1=1] - E[Y | X1=0] =", e_y_x1_1 - e_y_x1_0, "\n\n")

  cat("Var(Y | X1 = 1) =", var_y_x1_1, "\n")
  cat("Var(Y | X1 = 0) =", var_y_x1_0, "\n\n")

  cat("【X2（重症度）で条件付けた期待値】\n")
  cat("E[Y | X1=1, X2=1] =", e_y_x1_1_x2_1, "\n")
  cat("E[Y | X1=1, X2=0] =", e_y_x1_1_x2_0, "\n")
  cat("E[Y | X1=0, X2=1] =", e_y_x1_0_x2_1, "\n")
  cat("E[Y | X1=0, X2=0] =", e_y_x1_0_x2_0, "\n\n")

  cat("【潜在反応変数の整理】\n")
  cat("各個人には Y(1), Y(0) という潜在反応変数が存在する。\n")
  cat("観測される Y は、そのうち実際に割り当てられた X1 に対応する1つのみである。\n")
  cat("RCTでは X1 がランダム化されているため、E[Y | X1] は因果効果を表す。\n")


  ## ===============================
  ## その他の性質
  ## ===============================
  cat(" ======================= \n")
  cat(" ======== 一致性 ======= \n")
  cat(" ======================= \n")

  cat("各個体 i に、実際に観測された処置 X1_i = x に対する観測結果Y_iは、その処置に対する潜在反応変数 Y_i(x)と等しい。", "\n")
  cat("つまり、以下である。", "\n")
  cat(" ・一致性は、因果推論において観測結果と潜在反応変数を対応づけるための仮定である。", "\n")
  cat(" ・一致性は、処置の意味が一意に定義されていることを要求する。", "\n")
  cat(" ・一致性は、同じ処置に対して常に同じ意味の介入が行われたと仮定する。", "\n")
  cat("逆に言うと、以下である。", "\n")
  cat(" ・一致性は、「同じ X1=1 に対し、処置しなかった個体 i が混ざる」状況を許さない", "\n")
  cat(" ・一致性は、「同じ X1=1 に対し、処置内容の異なる個体 i が混ざる 」状況を許さない", "\n")

  for (i in 1:5) {
    cat(
      "個体", i,
      ": X1 =", df$x1[i],
      ", 観測された Y =", df$y[i],
      " → Y = Y(", df$x1[i], ")\n",
      sep = ""
    )
  }

  cat(" == 強い意味での無視可能性 == \n")
  cat("各個体 i において、共変量 X2_i を条件に仮定すると、潜在反応変数 {Y_i(1), Y_i(0)} は、X1_i と独立である。\n")

  cat("\n【共変量 X2 を条件にした処置割付の確認】\n")

  # X2 = 1 のとき
  p_x1_1_x2_1 <- mean(df$x1[df$x2 == 1])
  p_x1_0_x2_1 <- 1 - p_x1_1_x2_1

  cat("X2 = 1 のとき\n")
  cat("  P(X1 = 1 | X2 = 1) =", p_x1_1_x2_1, "\n")
  cat("  P(X1 = 0 | X2 = 1) =", p_x1_0_x2_1, "\n")

  # X2 = 0 のとき
  p_x1_1_x2_0 <- mean(df$x1[df$x2 == 0])
  p_x1_0_x2_0 <- 1 - p_x1_1_x2_0

  cat("X2 = 0 のとき\n")
  cat("  P(X1 = 1 | X2 = 0) =", p_x1_1_x2_0, "\n")
  cat("  P(X1 = 0 | X2 = 0) =", p_x1_0_x2_0, "\n")

  cat("\nX2 = 1 の場合と X2 = 0 の場合で、\n")
  cat("  P(X1 = 1 | X2 = 1) =", p_x1_1_x2_1, "\n")
  cat("  P(X1 = 1 | X2 = 0) =", p_x1_1_x2_0, "\n")
  cat("これらは大きく異なっておらず、処置 X1 は、共変量 X2 と独立に割り当てられていると考えられる。\n")
  cat("RCTでは処置 X1 が潜在反応変数および共変量と独立に割り当てられるため、結果として強い意味での無視可能性が成立する。\n")

  cat(" ======================= \n")
  cat(" ======= 正値性 ======== \n")
  cat(" ======================= \n")
  cat("各個体 i において、共変量 X2_i を条件に仮定すると、処置 X1_i は、０または１のいずれに対しても正の確率で割り当てられる。\n")

  cat("【共変量 X2 ごとの処置割付確率】\n")

  # X2 = 1 のとき
  p_x1_1_x2_1 <- mean(df$x1[df$x2 == 1])
  p_x1_0_x2_1 <- 1 - p_x1_1_x2_1

  cat("X2 = 1 のとき\n")
  cat("  P(X1 = 1 | X2 = 1) =", p_x1_1_x2_1, "\n")
  cat("  P(X1 = 0 | X2 = 1) =", p_x1_0_x2_1, "\n\n")

  # X2 = 0 のとき
  p_x1_1_x2_0 <- mean(df$x1[df$x2 == 0])
  p_x1_0_x2_0 <- 1 - p_x1_1_x2_0

  cat("X2 = 0 のとき\n")
  cat("  P(X1 = 1 | X2 = 0) =", p_x1_1_x2_0, "\n")
  cat("  P(X1 = 0 | X2 = 0) =", p_x1_0_x2_0, "\n\n")

  cat("すべての X2 の値に対して、\n")
  cat("  P(X1 = 1 | X2) > 0 かつ P(X1 = 0 | X2) > 0 が成り立つため、\n")
  cat("正値性は満たされている。\n")

  cat(" ======================= \n")
  cat(" === 正値性が破れる例 === \n")
  cat(" ======================= \n")
  cat("X2 = 1 のときは必ず X1 = 1 になる状況を作る\n")
  df_bad <- df
  df_bad$x1[df_bad$x2 == 1] <- 1

  p_bad <- mean(df_bad$x1[df_bad$x2 == 1])

  cat("X2 = 1 のときは必ず X1 = 1 になる状況を意図的に作った。\n")
  cat("その結果、X2 = 1 の個体は、以下になる。\n")
  cat("  P(X1 = 1 | X2 = 1) =", p_bad, "\n")
  cat("  P(X1 = 0 | X2 = 1) =", 1 - p_bad, "\n")
  cat("これは、X2 = 1 を条件とした場合に、処置 X1 = 0 が起こる確率が 0 であることを意味する。\n")
  cat("したがって、X2 = 1 の個体では両方の処置 { X1 = 0, X1 = 1 }が観測されず、正値性の仮定は満たされない。\n")


  cat(" ======================= \n")
  cat(" ====== 傾向スコア ====== \n")
  cat(" ======================= \n")

  cat("次の前提 \n")
  cat(" ・ X1_i（風邪薬） は、研究者が外部から操作して個体にランダムに割り当てる処置変数と定義する \n")
  cat(" ・ X2_i （重症度）は、個体が元々もつ属性を仮定した共変量と定義する \n")
  cat(" ・ 各個体 i において {Y_i(1), Y_i(0)} ⟂ X1_i | X2_i が成立すると仮定する ＝ 強い意味での無視可能性が成立すると仮定する \n")
  cat("強い意味での無視可能性は、以下である \n")
  cat(" ・ 個体 i の潜在結果（処置した場合 Y_i(1), しなかった場合 Y_i(0)）は、共変量 X2_i を条件にすれば処置 X1_i に依存しない \n")
  cat(" ・ これが成立すれば、観測データから反実仮想 Y_i(x) の条件付き期待値を推定できる \n")
  cat("この仮定の下では、以下が成立する \n")
  cat(" ・ E[Y(x) | X2] = E[Y | X1=x, X2] \n")
  cat("この式は、以下を表す。 \n")
  cat(" ・Y(x) は、処置を x に固定した場合の潜在結果（反実仮想） \n")
  cat(" ・Y は、実際に割り当てられた X1 に対応して観測された結果である。Y は、X1の関数ではない。 \n")
  cat("言い換えると、 \n")
  cat(" ・Y(0) と Y(1) は、両方とも最初から潜在的に存在している結果である。 \n")
  cat(" ・X1=x は、どちらが観測されるかを選択している \n")

  cat("個体  │     潜在結果    │ 処置変数  │ 観測される結果 \n")
  cat("i    │ Y_i(0) │ Y_i(1)	│ X1_i		 │  Y_i \n")
  cat("-----＋-------＋-------＋---------＋-------------- \n")
  cat("1  	│     0  │     1 	│      1 	 │    1 \n")
  cat("2  	│     0  │     1 	│      0 	 │    0 \n")
  cat("3  	│     0  │     1 	│      1 	 │    1 \n")


  cat("この前提の下で、傾向スコアは、以下のように定義される。\n")
  cat(" ・ 個体 i が処置 X1 = 1 を受ける確率を、共変量 X2_i に条件付けたもの。\n")
  cat(" ・ 数式で書くと e(X2_i) = P(X1_i = 1 | X2_i) で表される。\n\n")

  cat("傾向スコアの意味・使い方:\n")
  cat(" ・ 共変量 X2_i を考慮すると、傾向スコアは処置割り当ての確率を1つの数値に要約したもの。\n")
  cat(" ・ 強い意味での無視可能性が成立すれば、傾向スコアを用いることで、観測データから処置の効果を推定できる。\n")
  cat(" ・ つまり、傾向スコアでマッチングや重み付けを行えば、X2_i に条件付けた因果効果の推定が可能になる。\n\n")

  cat("今回の例では、RCTなので X1_i は X2_i に独立にランダム割り当てられるため、\n")
  cat("傾向スコアは X2_i によらずほぼ 0.5 になることが期待される。\n\n")


  # 傾向スコアを推定（ロジスティック回帰を使用）
  propensity_model <- glm(x1 ~ x2, family = binomial, data = df)
  df$pscore <- predict(propensity_model, type = "response")

  # 確認
  cat("【傾向スコアの確認（先頭6行）】\n")
  print(head(df[, c("x1", "x2", "pscore")]))

  cat("\n【傾向スコアの要約】\n")
  print(summary(df$pscore))

  cat(" ======================= \n")
  cat(" ====== まとめ ====== \n")
  cat(" ======================= \n")
  cat("１．集団・変数の定義 \n")
  cat("  ・集団		        ： 個体 i = 1..,n \n")
  cat("  ・処置変数 X1_i	： 研究者が操作する処置（風邪薬）の有無 \n")
  cat("  ・共変量   X2_i	： 個体の性質（重症度） \n")
  cat("  ・観測結果 Y_i 	： 実際に割り当てられた処置に応じた結果（風邪が治る・悪化するなど） \n")

  cat("２．潜在反応変数（反実仮想） \n")
  cat("この時、各個体には、潜在反応変数（反実仮想）が存在する。 \n")
  cat("  ・Y_i (0) : 処置（風邪薬）なし \n")
  cat("  ・Y_i (1) : 処置（風邪薬）あり \n")
  cat("ただし、実際に観測できるのは、割り当てられた処置に対する１つの結果のみ \n")

  cat("３．観測データから因果関係を数値化 \n")
  cat("  ・E[Y | X1]      ： 処置ごとの平均結果 \n")
  cat("  ・E[Y | X1, X2]  ： 共変量ごとの条件付き平均 \n")
  cat("  ・傾向スコア      ： e( X2_i ) = P ( X1_i=1 | X2_i ) 処置の割り付け確率を１つの数値で要約 \n")
  cat("これらを使うことで、集団に現れる平均的な因果効果（ATE）を数値で表現できる。 \n")

  cat("４．ランダム化比較試験（RCT） \n")
  cat("この時、 Y_i に対する処置 X1_i をランダムに割り当てている（RCT）。 \n")
  cat("RCTを用いることにより、観測データから平均的な因果効果（ATE）を推定できる。 \n")

  cat("
  n個からなる集団に対して、各個体 i に対する処置 X1_i（風邪薬の有無）や、共変量 X2_i（重症度）から、観測された結果 Y_i を用いて、
  条件付き期待値E[Y | X1]、E[Y | X1, X2]、傾向スコアなどを計算することで、手段に現れる因果関係を数値で表現できる。
  この時、X1_iは、ランダムに割当られているため、得られた数値は集団に対する平均的な因果効果（ATE）を示している。\n
  ")

  ################################################################################
  # 応用例 1. マーケティング施策の効果検証（広告・メールキャンペーン）
  ################################################################################
  # 集団に対して広告やメールを送った場合の効果を検証する例
  # ・X1_i : 広告を見たか / メールを受け取ったか（処置変数）
  # ・X2_i : 年齢、性別、過去購入履歴など（共変量）
  # ・Y_i  : 購入金額やクリック率、利用継続率（観測結果）
  # この場合、傾向スコアや条件付き期待値を用いることで、
  # 広告やメールが購入行動に与える平均的な因果効果を推定できる。

  ################################################################################
  # 応用例 2. 価格戦略やキャンペーン効果
  ################################################################################
  # 割引やキャンペーンが売上や購入頻度に与える影響を評価する例
  # ・X1_i : 割引を受けたか（処置変数）
  # ・X2_i : 過去購入数、顧客セグメントなど（共変量）
  # ・Y_i  : 売上、利益、購入頻度（観測結果）
  # 傾向スコアを使うと、共変量による偏りを調整して、
  # 割引の因果的な効果を推定できる。

  ################################################################################
  # 応用例 3. 製品・サービス改善の効果測定
  ################################################################################
  # 新機能や改善施策が顧客の利用継続や満足度に与える影響を評価する例
  # ・X1_i : 新機能を利用したか（処置変数）
  # ・X2_i : 利用頻度、年齢、課金履歴など（共変量）
  # ・Y_i  : 利用継続率、満足度スコア、課金額（観測結果）
  # 観測データから傾向スコアを計算してマッチングや重み付けを行うことで、
  # 新機能の導入が平均的にどの程度の効果を持つかを推定できる。

  ################################################################################
  # 応用例 4. 人材・組織施策の評価
  ################################################################################
  # 研修や教育施策が従業員の生産性や離職率に与える影響を評価する例
  # ・X1_i : 研修を受けたか（処置変数）
  # ・X2_i : 勤続年数、職種、過去の評価スコアなど（共変量）
  # ・Y_i  : 生産性、評価スコア、離職率（観測結果）
  # 傾向スコアを用いて、共変量の影響を調整すれば、
  # 研修の平均的な因果効果（ATE）を推定できる。

  # ###############################################################################
  # 疑問１
  # ###############################################################################
  # １．集団・変数の定義
  # ・集団		： 個体 i = 1..,n
  # ・処置変数 X1_i	： メール送信有無（0：送らない、1：送る）
  # ・共変量   X2_i	： 顧客の属性（性別など）
  # ・観測結果 Y_i 	： メールを送信した場合の結果（0：購入しない、1：購入した）

  # ２．潜在反応変数（反実仮想）
  # この時、各個体には、潜在反応変数（反実仮想）が存在する。
  # ・Y_i (1) : メールを送った場合の反応
  # ・Y_i (0) : メールを送らなかった場合の反応
  # ただし、実際に観測できるのは、割り当てられた処置に対する１つの結果のみ

  # ３．疑問
  # 既存データに基づくモデルは、「観測された集団内での処置と結果の平均的関係」を表現するだけである。
  # 例えば「新しい顧客 i+1 に対してメールを送るとどうなるか」という推定は、過去データの分布と同じ条件にある前提で、有効である。
  # このため、この推定は過去に観測した集団内での処置と結果の平均的関係と同じになる。

  # ビジネスの意思決定でよくやりたいことは、次のような比較です：
  # ・メールを送った結果の反応
  # ・メールを送らなかった結果の反応

  # つまり、
  # 観測データのみから、恣意的に処置を変更したときの結果を直接知ることはできない。
  # 「モデルから新しい施策の結果を予測する」という行為は、あくまで 既存データの条件分布が新しい状況にも当てはまる場合 の予測である。
  # 実際にメールを送るか送らないかを意図的に操作して比較する 実験（または擬似実験） を行うことで、初めて「処置の効果」を評価できる。

  # このため、メールを送った場合／メールを送らなかった場合の効果判定は、次のように２つの集団から観測して、得た因果効果を比較するしかない。
  # ・グループ 1 にメールを送った（ X1_i = 1 ）結果の反応（Y_i (0)、Y_i (1)）
  # ・グループ 2 にメールを送らなかった（ X1_i = 0 ）結果の反応（Y_i (0)、Y_i (1)）

  # ###############################################################################
  # 疑問２
  # ###############################################################################
  # １．集団・変数の定義
  #　 ・集団		： 個体 i = 1..,n
  #　 ・処置変数 X1_i	： メール送信有無（0：送らない、1：送る）
  #　 ・共変量   X2_i	： 顧客の属性（性別など）
  #　 ・観測結果 Y_i 	： 実際に割り当てられた処置に対応した結果（0：購入しない、1：購入した）
  #
  # 仮に、実世界の観測結果は、偏りがある分布だったと仮定する。例えばメールを送ると反応が多い 。
  # この観測結果に対して、RCTで処置 X1_i をランダム化して、個体に処置を割り当てその結果を観測すると、ランダム化によって 0.5 の確率に平均化されるのではないか。
  # これだと現実の実態を反映していないのではないか。
  #
  # RCTの目的は X2_iや他の潜在因子に影響されず、X1_i のみによる因果効果を正しく測る ことである。
  # つまり「処置 X1_i が本当に結果 Y に与える影響」を、他の要因の影響と切り離して観測するためにランダム化する。
  #
  # ランダム化対象は、操作可能な 処置変数 X1_i である。操作不可能な共変量 X2_iは、ランダム化しない。
  # 処置変数 X1_i をランダム化することによって、顧客の属性や、潜在的な購買行動と無関係に 処置変数 X1_i（メール送信する／メール送信しない）状況を人工的に作り出す。
  # これによって「処置 X1_i が本当に結果 Y に与える影響」を 評価する。
  #
  # なおランダム化で、0.5になるのは、P( X1_i = 1 )であって、結果Yが0.5になるわけではない。
  # 仮にメール送信に効果がある場合、 E[ Y | X1 = 1 ] > E[ Y | X1 = 0 ] になる。


}

main()
