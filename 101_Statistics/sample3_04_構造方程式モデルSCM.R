main <- function() {
  ## ===============================
  ## 基本設定
  ## ===============================

  set.seed(123)
  n <- 3000  # 被験者数
  id <- 1:n  # 被験者ID

  # １．前提
  #     ・集団          ： 個体 i = 1..,n
  #     ・処置変数 X1_i ： 研究者が操作する処置（風邪薬）の有無
  #     ・共変量   X2_i ： 個体の性質（重症度）
  #     ・観測結果 Y_i  ： 実際に割り当てられた処置に応じた結果（風邪が治る・悪化するなど）
  #
  # 　 X1_i は、RCTではランダム化される
  # 　 X2_i は、事前に決まっておりRCTではランダム化されない
  #
  # 　さらに次の世界を "設定" する。
  #   各個人 i には、以下の潜在反応変数が存在すると考える：
  #   ・Y_i(1): 風邪薬を飲んだ場合の結果
  #   ・Y_i(0): 風邪薬を飲まなかった場合の結果
  #
  #   ただし、その分布は 共変量 X2（重症度） に依存する：
  #   ・P(Y_i(1)=1 | X2=1) = 0.8
  #   ・P(Y_i(1)=1 | X2=0) = 0.5
  #   ・P(Y_i(0)=1 | X2=1) = 0.4
  #   ・P(Y_i(0)=1 | X2=0) = 0.2
  #
  #   実際に観測できるのは、割り当てられた X1 に対応する潜在反応変数 1 つのみ


  # ２．前提が表現する世界
  # 　"設定"した世界では、「重症度 X2 があり、風邪薬 X1 が Y に因果的に影響する」因果構造を前提としてデータを生成している。
  # 　⇒ 潜在反応変数は、”設定した因果データ生成過程（SCM）から導かれる量”である
  # 　⇒ 潜在反応変数は、”同一の SCM に対して do(X1=x) を加えたときに定義される量”である。（後述する）
  #
  # 　次の２つの違いである。
  # 　・観測した結果から、モデルを構築している。　観測データ → 因果モデル。  ＝ 推論。（以前は、こちらを記載）
  # 　・構築したモデルから、シミュレーションする。因果モデル → 介入後の世界。＝ 予測。（今回は、こちらを記載）


  # ３．因果ダイアグラム（DAG）　
  # 　X1_i（処置変数、風邪薬あり／風邪薬なし）┐
  #   　　　　　　　　　　　　　　　　　　　　├->　Y_i（観測結果、処置結果）
  # 　X2_i（共変量　、重症度重症／重症度継承）┘
  #
  # 　X2 は Y に影響する共変量であり、観測研究では交絡変数になり得るが、本設定（RCT）では X1 と独立であるため交絡（線）は生じない。


  # ４．構造方程式（SCM）　
  # 　前提に記載した内容を等価な構造方程式で表現すると以下になる。
  #
  # 　・内生変数 ： X1、　X2、　Y
  # 　・外生変数 ： U_X1、U_X2、UY
  # 　・構造方程式
  # 　　・X1 := U_X1              ⇒ ランダムに処置　（風邪薬の有無） X1_i	が決まる
  # 　　・X2 := U_X2              ⇒ ランダムに共変量（重症度の軽重） X2_i	が決まる
  # 　　・Y  := f( X1, X2, UY )   ⇒ X1、X2に加ええて、結果の偶発性   UY		が決まる
  #
  # ​
  # 　Rのコードは以下になる。
  # ```
  #   Y = Bernoulli(
  #     p = {
  #       0.8 if X1=1 & X2=1
  #       0.5 if X1=1 & X2=0
  #       0.4 if X1=0 & X2=1
  #       0.2 if X1=0 & X2=0
  #     }
  #   )
  # ```
  #
  # Yは「X1とX2から生成される」
  # ⇒ Y は (X1, X2, U_Y) の関数である。X1 は Y の生成メカニズムの一部を構成する。


  # ５．介入
  # 介入（do, doing）は、「X1 を“結果として観測する変数”から、“外から強制的に固定する操作”に変えること」を意味する。
  #
  # Y  := f( X1, X2, UY ) を構成するX1は、次の意味を持つ
  # ・X1 は、Y  を決める原因の一部
  # ・X1 は、X1自体が、確率変数（ U_X1 ）
  #
  # ５．１．観測（seeing）
  # X1 = 1 （風邪薬のあり）だった時に、Y （観測結果）は、どのように分布するか
  # 　・P( Y | X1 = 1 )
  # SCMで表現すると以下になる。
  # 　・P( Y | X1 = 1 )     =  ∑​（ P( Y ∣ X1=1 , X2=x2 , UY​=uy ) ・ P ( X2=x2, UY​=uy ​∣ X1=1 ) ）
  #
  # ５．２．介入（doing）
  # 観測の式を以下に変える。
  # 　　・X1 := 1			⇒ 固定に1（風邪薬のあり）			にする
  # 　　・X2 := U_X2		⇒ ランダムに共変量（重症度の軽重） X2_i	が決まる
  # 　　・Y  := f( X1, X2, UY )　	⇒ X1、X2に加ええて、結果の偶発性   UY		が決まる
  # SCMで表現すると以下になる。
  # 　・P( Y | do( X1=1 ) ) =  ∑​（ P( Y ∣ X1=1 , X2=x2 , UY​=uy ) ・ P ( X2=x2 , UY​=uy ​））
  #                         =  ∑​（ P( Y ∣ X1=1 , X2=x2 ) ・ P ( X2=x2 ​））
  #
  # 因果ダイアグラムは、以下になる。
  # 　X1_i（処置変数、風邪薬あり固定　　　　）┐
  #   　　　　　　　　　　　　　　　　　　　　├->　Y_i（観測結果、処置結果）
  # 　X2_i（共変量　、重症度重症／重症度継承）┘

  cat("=========== ケース１ ===========\n")

  # =====================================================
  # 1. 外生変数（Exogenous variables）
  # =====================================================
  U_X1 <- rbinom(n, 1, 0.5)   # RCT：処置はランダム
  U_X2 <- rbinom(n, 1, 0.4)   # 重症度（事前に決まる）
  U_Y  <- runif(n)            # 結果の偶発性（Bernoulli乱数に暗黙的に含まれるためコード上は使わない）

  # =====================================================
  # 2. 観測世界（seeing）
  # =====================================================
  # 構造方程式
  X1 <- U_X1                 # 処置（確率変数）
  X2 <- U_X2                 # 共変量

  p_Y <- ifelse(X1 == 1 & X2 == 1, 0.8,
         ifelse(X1 == 1 & X2 == 0, 0.5,
         ifelse(X1 == 0 & X2 == 1, 0.4,
                                   0.2)))

  Y <- rbinom(n, 1, p_Y)

  rct_data <- data.frame(
    world = "observed",
    id = id,
    X1 = X1,
    X2 = X2,
    Y  = Y
  )

  # 観測量：P(Y | X1 = 1)
  p_Y_given_X1_1 <- mean(rct_data$Y[rct_data$X1 == 1])

  cat("RCT : P( Y |    X1=1 ) = ",  p_Y_given_X1_1, "\n")

  # =====================================================
  # 3. 介入世界（doing）
  # =====================================================
  # do(X1 = 1)
  X1_do <- rep(1, n)         # 確率変数ではなく「固定」
  X2_do <- U_X2              # 共変量は同じ分布

  p_Y_do <- ifelse(X1_do == 1 & X2_do == 1, 0.8,
            ifelse(X1_do == 1 & X2_do == 0, 0.5,
            ifelse(X1_do == 0 & X2_do == 1, 0.4,
                                         0.2)))

  Y_do <- rbinom(n, 1, p_Y_do)

  do_data <- data.frame(
    world = "do(X1=1)",
    id = id,
    X1 = X1_do,
    X2 = X2_do,
    Y  = Y_do
  )

  # 介入効果：P(Y | do(X1 = 1))
  p_Y_do_X1_1 <- mean(do_data$Y)

  cat("RCT : P( Y | do(X1=1)) = ",  p_Y_do_X1_1, "\n")

  # 理論上は、観測と介入は同じになるはず
  cat("( seeing - doing )     = ",  p_Y_given_X1_1 - p_Y_do_X1_1,  "\n")

  # =====================================================
  # 4. データの比較
  # =====================================================
  merged_data <- merge(
    rct_data,
    do_data,
    by = "id"
  )

  print(head(merged_data, 6))

  # ６．前提を置き換えるケース
  # 前提を以下に設定した場合、
  #   ・集団		： 個体 i = 1..,n
  #   ・処置変数 X1_i	： 研究者が操作する処置（風邪薬）の有無
  #   ・共変量   X2_i	： 個体の性質（重症度）
  #   ・観測結果 Y_i 	： 実際に割り当てられた処置に応じた結果（風邪が治る・悪化するなど）
  #
  # 　 X1_i は、ランダム化されない（観測研究）
  # 　 X2_i は、事前に決まっておりRCTではランダム化されない
  #
  # ６．１観測
  # 因果ダイアグラムは、以下になる
  # 　X1_i（処置変数、風邪薬あり／風邪薬なし）┐
  #   　↑　　　　　　　　　　　　　　　　　　├->　Y_i（観測結果、処置結果）
  # 　X2_i（共変量、　重症度重症／重症度継承）┘
  #
  # このとき X2 は X1 と Y の両方に影響するため、交絡（線）が生じている。
  #
  # SCMは、以下になる
  # 　・P( Y | X1 = 1 )     =  ∑​（ P( Y ∣ X1=1 , X2=x2 , UY​=uy ) ・ P ( X2=x2, UY​=uy ​∣ X1=1 ) ）
  #
  # ６．２介入
  # 因果ダイアグラムは、以下になる
  # 　X1_i（処置変数、風邪薬あり固定　　　　）┐
  #   　　　　　　　　　　　　　　　　　　　　├->　Y_i（観測結果、処置結果）
  # 　X2_i（共変量　、重症度重症／重症度継承）┘
  #
  # SCMは、以下になる
  # 　・P( Y | do( X1=1 ) ) =  ∑​（ P( Y ∣ X1=1 , X2=x2 , UY​=uy ) ・ P ( X2=x2 , UY​=uy ​））
  #                         =  ∑​（ P( Y ∣ X1=1 , X2=x2 ) ・ P ( X2=x2 ​））
  # つまり、do 介入とは「確率変数だった X1 を、確率分布から切り離して定数に置き換える操作」である。

  cat("=========== ケース２ ===========\n")
  # =====================================================
  # 1. 外生変数（Exogenous variables）
  # =====================================================
  U_X2 <- rbinom(n, 1, 0.4)  # 重症度
  U_X1 <- runif(n)           # 処置割当の偶発性
  U_Y  <- runif(n)           # 結果の偶発性（Bernoulli乱数に暗黙的に含まれるためコード上は使わない）

  # =====================================================
  # 2. 観測世界（seeing：交絡あり）
  # =====================================================
  # 構造方程式
  X2 <- U_X2

  # 重症ほど薬を飲みやすい（X2 → X1）
  X1 <- ifelse(
    X2 == 1,
    as.numeric(U_X1 < 0.8),  # 重症者は8割が服薬
    as.numeric(U_X1 < 0.3)   # 軽症者は3割が服薬
  )

  # 結果生成（SCMはRCTと同一）
  p_Y <- ifelse(X1 == 1 & X2 == 1, 0.8,
         ifelse(X1 == 1 & X2 == 0, 0.5,
         ifelse(X1 == 0 & X2 == 1, 0.4,
                                   0.2)))

  Y <- rbinom(n, 1, p_Y)

  obs_data <- data.frame(
    world = "observed",
    id = id,
    X1 = X1,
    X2 = X2,
    Y  = Y
  )

  # 観測量：P(Y | X1 = 1)
  p_Y_given_X1_1_obs <- mean(obs_data$Y[obs_data$X1 == 1])

  cat("OBS : P( Y |    X1=1 ) = ", p_Y_given_X1_1_obs, "\n")

  # =====================================================
  # 3. 介入世界（doing）
  # =====================================================
  # do(X1 = 1)
  X1_do <- rep(1, n)     # ← 確率変数を切断
  X2_do <- U_X2          # 共変量は自然分布のまま

  p_Y_do <- ifelse(X1_do == 1 & X2_do == 1, 0.8,
            ifelse(X1_do == 1 & X2_do == 0, 0.5,
            ifelse(X1_do == 0 & X2_do == 1, 0.4,
                                         0.2)))

  Y_do <- rbinom(n, 1, p_Y_do)

  do_data <- data.frame(
    world = "do(X1=1)",
    id = id,
    X1 = X1_do,
    X2 = X2_do,
    Y  = Y_do
  )

  # 介入効果：P(Y | do(X1 = 1))
  p_Y_do_X1_1_obs <- mean(do_data$Y)

  cat("OBS : P( Y | do(X1=1)) = ", p_Y_do_X1_1_obs, "\n")

  # 理論上は、観測と介入は差が生じるはず
  cat("( seeing - doing )     = ",  p_Y_given_X1_1_obs - p_Y_do_X1_1_obs,  "\n")

  # =====================================================
  # 4. データの比較
  # =====================================================
  merged_data <- merge(
    obs_data,
    do_data,
    by = "id"
  )

  print(head(merged_data, 6))


}

main()
